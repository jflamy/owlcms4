pipeline {
    agent any
    
    parameters {
        string(name: 'M2', defaultValue: 'c:/dev/.m2', description: 'where to find the Maven settings and Maven secrets')
        string(name: 'VERSION', defaultValue: 'Missing', description: 'used for tagging')
        string(name: 'REPO_OWNER', defaultValue: 'owlcms', description: 'owlcms or jflamy-dev')
        string(name: 'O_REPO_NAME', defaultValue: 'owlcms4', description: 'owlcms4 or owlcms4-prerelease')
        string(name: 'P_REPO_NAME', defaultValue: 'publicresults-heroku', description: 'publicresults-heroku or publicresults-heroku-prerelease')
        string(name: 'PRERELEASE', defaultValue: 'true', description: 'true or false')
        string(name: 'REPO_TOKEN_NAME', defaultValue: 'github-oauth', description: 'from Maven settings')
    }
    
    tools { 
        maven '3.6.2' 
        jdk 'jdk8' 
    }

    stages {
        stage('Reset workspace') {
            environment {
                TOKEN = credentials('jflamy-pw')
            }
            steps {
                bat "echo %M2% %REPO_TOKEN_NAME% %VERSION% %GIT_BRANCH% %BRANCH%"
                bat 'rmdir /s /q publicresults-heroku'
            }
        }
        
        stage('Update git & submodules') {      
            steps {
                bat 'git checkout --recursive %GIT_BRANCH%'
                bat 'git pull'
//                bat 'git submodule sync'
//                bat 'git submodule update --init --recursive'
//                bat 'git submodule foreach "git fetch && git reset --hard origin/%GIT_BRANCH% && git checkout %GIT_BRANCH% && git pull"'
            }
        }
        
        stage('Build owlcms') {
            steps {
                dir('owlcms') {
                    bat 'mvn -s %M2%/settings.xml -B clean package -P production,signing'
                }
            }
        }
        
        stage('Build publicresults') {
            steps {
                dir('publicresults') {
                    bat 'mvn -s %M2%/settings.xml -B clean install -P production'
                }
            }
        }
        
        stage('Release publicresults jar to bintray') {
            steps {
                dir('publicresults') {
                    bat 'mvn -s %M2%/settings.xml -B deploy:deploy-file@deploy-file'
                }
            }
        }
        
       stage('Release publicresults-heroku to Heroku') {
            environment {
                TOKEN = credentials('jflamy-pw')
                TOKEN2 = credentials('jflamy-dev-pw')
            }
            steps {
                dir('publicresults-heroku') {
                    bat 'git pull'
                    bat 'mvn -s %M2%/settings.xml -B clean package'
                    // save the locally built files
                    bat 'git stash'

                    // create a tag with the current version number, but not the locally built files
                    bat 'git tag %VERSION% -f -a -m "%VERSION% publicresults-heroku"'
                    // push changes and tag back to upstream master repo
                    bat 'git push https://%TOKEN%@github.com/%TOKEN_USR%/publicresults-heroku.git %GIT_BRANCH%'
                    bat 'git push https://%TOKEN%@github.com/%TOKEN_USR%/publicresults-heroku.git %VERSION%'

                    // push new version and tag to the repo used by heroku as a cloning reference.
                    bat 'git stash pop'
                    bat 'git add -A && git commit -m "%VERSION% heroku" --allow-empty'
                    bat 'git push https://%TOKEN%@github.com/%REPO_OWNER%/%P_REPO_NAME%.git %GIT_BRANCH%:master --force'
                    bat 'git push https://%TOKEN%@github.com/%REPO_OWNER%/%P_REPO_NAME%.git %VERSION%'

                    // The heroku deploy button pointing to the proper tagged version is part of the release notes.
                    // github.owner is the repo owning organization or user; the github-oauth gives us repo write access.
                    bat 'mvn -s c:/dev/.m2/settings.xml -B github-release:github-release@release-cli -Dgithub.owner=%REPO_OWNER% -Dgithub.repository=%P_REPO_NAME% -Dgithub.token=github-oauth -Dgithub.prerelease=%PRERELEASE%'
                }       
            }
        }
        
        stage('GitHub release') {
            environment {
                TOKEN = credentials('jflamy-pw')
            }
            steps {
                dir('.') {
                    bat 'git pull'
                    // create release files
                    bat 'mvn -s c:/dev/.m2/settings.xml -B package --non-recursive'
                    bat 'git add -A && git commit -m "%VERSION%" --allow-empty'
                    // create a local tag with the current version number
                    bat 'git tag %VERSION% -f -a -m "%VERSION% owlcms4"'

                    // push changes back to upstream master repo
                    bat 'git push https://%TOKEN%@github.com/%TOKEN_USR%/owlcms4.git %GIT_BRANCH%'
                    bat 'git push https://%TOKEN%@github.com/%TOKEN_USR%/owlcms4.git %VERSION%'
                    
                    // push new files to downstream release channel repo where executables will be added (a remote tag will be added by github)
                    bat 'git push https://%TOKEN%@github.com/%REPO_OWNER%/%O_REPO_NAME% %GIT_BRANCH%'                  

                    // github.owner is the repo owning organization or user; the github-oauth gives us repo write access using the API
                    bat 'mvn -s c:/dev/.m2/settings.xml -B github-release:github-release -Dgithub.owner=%REPO_OWNER% -Dgithub.repository=%O_REPO_NAME% -Dgithub.token=github-oauth -Dgithub.prerelease=%PRERELEASE% --non-recursive'
                }
            }
        }
        
    }
}